<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cloud Antivirus — Анализ файлов</title>
  <link rel="stylesheet" href="/static/index.css">
</head>
<body>
<header>
  <div class="brand">
    <div id="homeBtn" class="logo" aria-hidden="true">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M12 2a5 5 0 00-4.9 4.07A4.5 4.5 0 005 11.5 4.5 4.5 0 009.5 16h7a3.5 3.5 0 00.5-6.99A5 5 0 0012 2z"/>
      </svg>
    </div>
    <div>
      <h1>CLOUD ANTIVIRUS</h1>
      <div style="font-size:12px;color:var(--muted)">Облачный анализ загружаемых файлов</div>
    </div>
  </div>

  <nav aria-label="Главная навигация">
    <button id="enterBtn" title="Enter (вход/регистрация)">Enter</button>
    <button id="replacementText" href="/settings" style="display: none;">Button is hidden!</button>
    <button id="exitBtn" style="display: none;">Exit</button>
    <button id="historyBtn">History</button>
    <button id="settingsBtn">Settings</button>
    <button id="contactBtn">Contact</button>
  </nav>
</header>

<main class="card" role="main" aria-labelledby="mainTitle">
  <h2 id="mainTitle" class="hero-title">ANALYZING FILES</h2>

  <div class="illu" aria-hidden="false">
    <div class="cloud" role="img" aria-label="Облако анализа">
      <div class="file-icon" aria-hidden="true">
        <div class="corner"></div>
        <div style="height:6px;width:60%;background:#f1f6ff;border-radius:4px"></div>
        <div style="height:6px;width:80%;background:#f1f6ff;border-radius:4px"></div>
        <div style="height:6px;width:40%;background:#f1f6ff;border-radius:4px"></div>
      </div>
    </div>

    <div style="display:flex;flex-direction:column;align-items:center;gap:10px">
      <div class="magnifier" aria-hidden="true">
        <svg width="46" height="46" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="#0b2540" stroke-width="1.6">
          <path d="M21 21l-4.35-4.35" stroke-linecap="round" stroke-linejoin="round"></path>
          <path d="M13 7a5 5 0 11-4 8.66" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      </div>
    </div>
  </div>

  <div class="progress" aria-hidden="false" aria-label="Прогресс сканирования">
    <div class="bar" id="progressBar" style="width:0%"></div>
  </div>

  <div class="status" id="statusText">Your files are waiting to be scanned...</div>

  <div class="controls" role="group" aria-label="Управление">
    <label class="file-label" for="fileInput" id="fileLabelBtn">Choose file</label>
    <input type="file" id="fileInput" aria-label="Выбрать файл для сканирования" />
    <button class="btn" id="scanBtn" disabled>Scan</button>
    <button class="btn secondary" id="resetBtn">Reset</button>
  </div>

  <div class="result" id="resultText" aria-live="polite" style="display:none"></div>
</main>

<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document" aria-labelledby="modalTitle">
    <button class="close-x" id="modalClose" aria-label="Close">&times;</button>
    <h2 id="modalTitle">Вход / Регистрация</h2>
    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="login" role="tab" aria-selected="true">Login</div>
      <div class="tab" data-tab="register" role="tab" aria-selected="false">Register</div>
    </div>

    <form id="authForm">
      <div id="loginFields">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input id="loginEmail" type="email" required placeholder="you@example.com" />
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input id="loginPassword" type="password" required placeholder="••••••••" />
        </div>
        <div class="actions">
          <button id="signBtn" type="submit" class="btn">Sign in</button>
        </div>
      </div>

      <div id="registerFields" style="display:none">
        <div class="form-group">
          <label for="regName">Full name</label>
          <input id="regName" type="text" required placeholder="Ivan Ivanov" />
        </div>
        <div class="form-group">
          <label for="regEmail">Email</label>
          <input id="regEmail" type="email" required placeholder="you@example.com" />
        </div>
        <div class="form-group">
          <label for="regPassword">Password</label>
          <input id="regPassword" type="password" required placeholder="Минимум 8 символов" />
        </div>
        <div class="form-group">
          <label for="regPassword2">Confirm password</label>
          <input id="regPassword2" type="password" required placeholder="Повторите пароль" />
        </div>
        <div class="actions">
          <div style="margin-top:10px;color:var(--muted);font-size:13px">
          1. ФИО вводится через пробел;
          2. Пароль должен быть не менее 8 символов и должен содержать спец. символы (!,@,#,$,&).
        </div>
          <button id="regBtn" class="btn">Create account</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>

const enterBtn = document.getElementById('enterBtn');
const exitBtn = document.getElementById('exitBtn');
  const settingsBtn = document.getElementById('settingsBtn');
  const homeBtn = document.getElementById('homeBtn');
  const historyBtn = document.getElementById('historyBtn');

  const replaceTxt = document.getElementById('replacementText');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalClose = document.getElementById('modalClose');

  const modalBackdrop1 = document.getElementById('modalBackdrop1');
  const modalClose1 = document.getElementById('modalClose1');

  const tabs = document.querySelectorAll('.tab');
  const loginFields = document.getElementById('loginFields');

  const registerFields = document.getElementById('registerFields');
  const regBtn = document.getElementById('regBtn');

  const authForm = document.getElementById('authForm');
  const signBtn = document.getElementById('signBtn');

  const fileInput = document.getElementById('fileInput');
  const fileLabelBtn = document.querySelector('.file-label');
  const scanBtn = document.getElementById('scanBtn');
  const resetBtn = document.getElementById('resetBtn');
  const statusText = document.getElementById('statusText');
  const progressBar = document.getElementById('progressBar');
  const resultText = document.getElementById('resultText');

document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/check-auth')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.authenticated) {
                enterBtn.style.display = 'none';
                replaceTxt.style.display = 'inline';
                replaceTxt.textContent = data.email;
            } else {
                enterBtn.style.display = '';
                replaceTxt.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error checking auth status:', error);
            enterBtn.style.display = '';
            replaceTxt.style.display = 'none';
        });
});

function updateAuthUI(isAuthenticated, email = '') {
    if (isAuthenticated) {
        enterBtn.style.display = 'none';
        replaceTxt.style.display = 'inline';
        replaceTxt.textContent = email;
        exitBtn.style.display = 'inline';
    } else {
        enterBtn.style.display = '';
        replaceTxt.style.display = 'none';
        exitBtn.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/check-auth')
        .then(response => response.json())
        .then(data => {
            updateAuthUI(data.authenticated, data.email);
            document.getElementById('regName').value = '';
            document.getElementById('regEmail').value = '';
        })
        .catch(error => {
            console.error('Auth check failed:', error);
            updateAuthUI(false);
        });
});

exitBtn.addEventListener('click', () => {
    if (confirm('Вы уверены, что хотите выйти?')) {
        logoutUser();
    }
});

historyBtn.addEventListener('click', () => {
  window.location.href = '/history';
})

homeBtn.addEventListener('click', () => {
  window.location.href = '/';
})

replaceTxt.addEventListener('click', () => {
  document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/check-auth')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.authenticated) {
                enterBtn.style.display = 'none';
                replaceTxt.style.display = 'inline';
                replaceTxt.textContent = data.email;
            } else {
                enterBtn.style.display = '';
                replaceTxt.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error checking auth status:', error);
            enterBtn.style.display = '';
            replaceTxt.style.display = 'none';
        });
    });
    alert(replaceTxt.textContent);
    if (replaceTxt.textContent == "admin@admin.ru") {
      window.location.href = '/road';
    } else {
      alert("You are not an admin!");
    }
})

function logoutUser() {
    fetch('/logout', {
        method: 'POST',
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.ok) {
            // Успешный выход - обновляем UI
            updateAuthUI(false);
            // Очищаем поля формы входа
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            alert('Вы успешно вышли из системы');
        } else {
            throw new Error('Logout failed');
        }
    })
    .catch(error => {
        console.error('Logout error:', error);
        alert('Ошибка при выходе из системы');
    });
}

function openModal(){
  modalBackdrop.style.display = 'flex';
  modalBackdrop.setAttribute('aria-hidden','false');
  setTimeout(()=>document.getElementById('loginEmail').focus(), 100);
}

function closeModal(){
  modalBackdrop.style.display = 'none';
  modalBackdrop.setAttribute('aria-hidden','true');
}

enterBtn.addEventListener('click', openModal);
modalClose.addEventListener('click', closeModal);

modalBackdrop.addEventListener('click', (e)=>{
  if(e.target === modalBackdrop) closeModal();
});

tabs.forEach(t=>{
  t.addEventListener('click', ()=>{
    tabs.forEach(x=>{
      x.classList.toggle('active', x===t);
      x.setAttribute('aria-selected', x===t ? 'true' : 'false');
    });
    const tab = t.dataset.tab;
    if(tab === 'login'){
      loginFields.style.display = '';
      registerFields.style.display = 'none';
    } else {
      loginFields.style.display = 'none';
      registerFields.style.display = '';
    }
  });
});

authForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const activeTab = document.querySelector('.tab.active').dataset.tab;
  if(activeTab === 'login'){
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPassword').value;
    if(!email || !pass){ alert('Заполните поля'); return; }
    alert('Успешный вход (демо).');
    closeModal();
  } else {
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const p1 = document.getElementById('regPassword').value;
    const p2 = document.getElementById('regPassword2').value;
    if(!name || !email || !p1 || !p2){ alert('Заполните поля'); return; }
    if(p1.length < 8){ alert('Пароль должен быть минимум 8 символов'); return; }
    if(p1 !== p2){ alert('Пароли не совпадают'); return; }
    closeModal();
  }
});

regBtn.addEventListener('click', () => {
  const name = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const p1 = document.getElementById('regPassword').value;
  const p2 = document.getElementById('regPassword2').value;
  if(!name || !email || !p1 || !p2){ alert('Заполните поля'); return; }
  if(p1.length < 8){ alert('Пароль должен быть минимум 8 символов'); return; }
  if(p1 !== p2){ alert('Пароли не совпадают'); return; }
    
  const form = new FormData();
  form.append('name', name);
  form.append('email', email);
  form.append('p1', p1);
        
  const xhr = new XMLHttpRequest();
  xhr.open('POST', '/reg', true);
        
  xhr.onreadystatechange = () => {
    if (xhr.readyState === 4) {
      if (xhr.status >= 200 && xhr.status < 300) {
        const res = JSON.parse(xhr.responseText);
        alert(res.output);
        document.getElementById('regName').value = '';
        document.getElementById('regEmail').value = '';
        document.getElementById('regPassword').value = '';
        document.getElementById('regPassword2').value = '';
      }
    }
  };
  xhr.send(form);
  closeModal();
});

signBtn.addEventListener('click', ()=> {
  const loginEmail = document.getElementById('loginEmail').value.trim();
  const loginPassword = document.getElementById('loginPassword').value.trim();
    
  const form = new FormData();
  form.append('email', loginEmail);
  form.append('p1', loginPassword);
    
  const xhr = new XMLHttpRequest();
  xhr.open('POST', '/sign', true);
    
  xhr.onreadystatechange = () => {
    if (xhr.readyState === 4) {
      if (xhr.status >= 200 && xhr.status < 300) {
        try {
          const res = JSON.parse(xhr.responseText);
          if (res.output == 1) {
            // Успешный вход
            updateAuthUI(true, loginEmail);
            closeModal();
          } else {
            alert('Ошибка входа: неверные данные');
          }
        } catch (e) {
          console.error('Error parsing response:', e);
          alert('Ошибка при обработке ответа сервера');
        }
      }
    }
  };
  
  xhr.send(form);
});

fileLabelBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', ()=>{
  if(fileInput.files && fileInput.files.length){
    const f = fileInput.files[0];
    fileLabelBtn.textContent = `${f.name} (${Math.round(f.size/1024)} KB)`;
    scanBtn.disabled = false;
    statusText.textContent = 'Файл готов. Нажмите Scan для запуска анализа.';
    resultText.style.display = 'none';
    progressBar.style.width = '0%';
  } else {
    fileLabelBtn.textContent = 'Choose file';
    scanBtn.disabled = true;
    statusText.textContent = 'Your files are waiting to be scanned...';
  }
});

let scanning = false;
scanBtn.addEventListener('click', () => {
  if (scanning) return;
  if (!fileInput.files.length) { alert('Выберите файл'); return; }
  const file = fileInput.files[0];
  const form = new FormData();
  form.append('file', file);

  const rules = localStorage.getItem('activeRulesFile');
  alert(rules);
  form.append('rules', rules);

  scanning = true;
  scanBtn.disabled = true;
  resetBtn.disabled = true;
  resultText.style.display = 'none';
  statusText.textContent = 'Uploading...';
  progressBar.style.width = '0%';

  const xhr = new XMLHttpRequest();
  xhr.open('POST', '/scan', true);

  xhr.upload.addEventListener('progress', (e) => {
    if (e.lengthComputable) {
      const percent = Math.round((e.loaded / e.total));
      progressBar.style.width = percent + '%';
    }
  });

  xhr.onreadystatechange = () => {
    if (xhr.readyState === 4) {
      // загрузка + сервер ответили
      if (xhr.status >= 200 && xhr.status < 300) {
        try {
          const res = JSON.parse(xhr.responseText);
          let parsed = null;
          try { parsed = JSON.parse(res.output); } catch(e) { parsed = null; }

          if (parsed) {
            // показываем результат сканера
            if (parsed.infected) {
              resultText.style.color = 'var(--danger)';
              resultText.textContent = 'Внимание: файл содержит подозрительные сигнатуры — возможное вредоносное ПО.';
            } else {
              resultText.style.color = 'var(--success)';
              resultText.textContent = res.output;
            }
            resultText.style.display = '';
            console.log('scanner result:', parsed);
          } else {
            resultText.style.color = 'var(--muted)';
            resultText.textContent = res.output || '(no output)';
            resultText.style.display = '';
          }

          statusText.textContent = 'Scan complete.';
          progressBar.style.width = '100%';
        } catch (err) {
          statusText.textContent = 'Ошибка парсинга ответа от сервера';
          resultText.style.display = '';
          resultText.style.color = 'var(--danger)';
          resultText.textContent = 'Server error: ' + err.message;
        }
      } else {
        statusText.textContent = 'Server error: ' + xhr.status;
        resultText.style.display = '';
        resultText.style.color = 'var(--danger)';
        resultText.textContent = xhr.responseText || ('HTTP ' + xhr.status);
      }

      scanning = false;
      resetBtn.disabled = false;
      scanBtn.disabled = false;
    } else {
      if (xhr.readyState === 2 || xhr.readyState === 3) {
        const cur = parseFloat(progressBar.style.width) || 0;
        if (cur < 50) progressBar.style.width = '50%';
        statusText.textContent = 'Scanning on server...';
        let p = Math.max(50, cur);
        const tick = setInterval(() => {
          if (p < 90) {
            p += 1 + Math.random() * 2;
            progressBar.style.width = Math.min(p, 90) + '%';
          } else {
            clearInterval(tick);
          }
        }, 200);
      }
    }
  };

  xhr.send(form);
});

resetBtn.addEventListener('click', ()=>{
  fileInput.value = '';
  fileLabelBtn.textContent = 'Choose file';
  scanBtn.disabled = true;
  progressBar.style.width = '0%';
  statusText.textContent = 'Your files are waiting to be scanned...';
  resultText.style.display = 'none';
});

document.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && document.activeElement === enterBtn){
    openModal();
  }
  if(e.key === 'Escape'){
    closeModal();
  }
});
</script>

</body>
</html>
